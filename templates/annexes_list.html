{% extends "base.html" %}
{% block content %}
{% if download %}
  <iframe src="{{ download }}" style="display:none" aria-hidden="true"></iframe>
{% endif %}

<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: var(--space-6); margin-bottom: var(--space-6);">
  <div class="card" style="border-left: 4px solid var(--teal-500); background: linear-gradient(135deg, #FFFFFF 0%, var(--teal-50) 100%); position: relative; overflow: hidden;">
    <div style="position: absolute; top: -50%; right: -50%; width: 200px; height: 200px; background: radial-gradient(circle, rgba(20, 184, 166, 0.1) 0%, transparent 70%); border-radius: 50%;"></div>
    <div class="card-body" style="padding: var(--space-6); position: relative; z-index: 1;">
      <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: var(--space-3);">
        <div style="width: 56px; height: 56px; background: linear-gradient(135deg, var(--teal-500), var(--teal-700)); border-radius: var(--radius-xl); display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(20, 184, 166, 0.3);">
          <svg style="width: 28px; height: 28px; color: white;" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
        </div>
        <span class="badge badge-teal" style="font-size: var(--text-sm); padding: 6px 14px;">üìÖ {{ year }}</span>
      </div>
      <div class="stats-value" style="font-size: var(--text-4xl); color: var(--teal-700); margin-bottom: var(--space-2);">{{ stats.total_annexes }}</div>
      <div class="stats-label" style="color: var(--text-secondary);">T·ªïng s·ªë ph·ª• l·ª•c</div>
    </div>
  </div>

  <div class="card" style="border-left: 4px solid var(--secondary-500); background: linear-gradient(135deg, #FFFFFF 0%, var(--secondary-50) 100%); position: relative; overflow: hidden;">
    <div style="position: absolute; top: -50%; right: -50%; width: 200px; height: 200px; background: radial-gradient(circle, rgba(34, 197, 94, 0.1) 0%, transparent 70%); border-radius: 50%;"></div>
    <div class="card-body" style="padding: var(--space-6); position: relative; z-index: 1;">
      <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: var(--space-3);">
        <div style="width: 56px; height: 56px; background: linear-gradient(135deg, var(--secondary-500), var(--secondary-700)); border-radius: var(--radius-xl); display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);">
          <svg style="width: 28px; height: 28px; color: white;" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        </div>
        <span class="badge badge-green" style="font-size: var(--text-sm); padding: 6px 14px;">üí∞ VNƒê</span>
      </div>
      <div class="stats-value" style="font-size: var(--text-3xl); color: var(--secondary-700); margin-bottom: var(--space-2);">{{ "{:,}".format(stats.total_value).replace(",", ".") }}</div>
      <div class="stats-label" style="color: var(--text-secondary);">T·ªïng gi√° tr·ªã ph·ª• l·ª•c</div>
    </div>
  </div>

  <div class="card" style="border-left: 4px solid var(--primary-500); background: linear-gradient(135deg, #FFFFFF 0%, var(--primary-50) 100%); position: relative; overflow: hidden;">
    <div style="position: absolute; top: -50%; right: -50%; width: 200px; height: 200px; background: radial-gradient(circle, rgba(59, 130, 246, 0.1) 0%, transparent 70%); border-radius: 50%;"></div>
    <div class="card-body" style="padding: var(--space-6); position: relative; z-index: 1;">
      <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: var(--space-3);">
        <div style="width: 56px; height: 56px; background: linear-gradient(135deg, var(--primary-500), var(--primary-700)); border-radius: var(--radius-xl); display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);">
          <svg style="width: 28px; height: 28px; color: white;" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
        </div>
        <span class="badge badge-blue" style="font-size: var(--text-sm); padding: 6px 14px;">üìä Th·ªëng k√™</span>
      </div>
      <div class="stats-value" style="font-size: var(--text-4xl); color: var(--primary-700); margin-bottom: var(--space-2);">{{ stats.unique_contracts }}</div>
      <div class="stats-label" style="color: var(--text-secondary);">H·ª£p ƒë·ªìng c√≥ ph·ª• l·ª•c</div>
      {% if stats.most_annexes_contract %}
      <div style="margin-top: var(--space-4); padding-top: var(--space-3); border-top: 1px solid var(--border);">
        <div style="font-size: var(--text-sm); color: var(--text-secondary);">Nhi·ªÅu PL nh·∫•t:</div>
        <div style="font-size: var(--text-sm); color: var(--primary-700); font-weight: var(--font-semibold); margin-top: var(--space-1);">
          {{ stats.most_annexes_contract[:20] }}... ({{ stats.most_annexes_count }} PL)
        </div>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<div class="card">
  <div class="card-header" style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: var(--space-4); border-left: 4px solid var(--teal-500);">
    <div>
      <h1 class="card-title" style="color: var(--teal-800); display: flex; align-items: center; gap: var(--space-3);">
        <svg style="width: 28px; height: 28px; color: var(--teal-600);" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
        </svg>
        Danh s√°ch ph·ª• l·ª•c
      </h1>
      <p style="font-size: var(--text-sm); color: var(--text-secondary); margin-top: var(--space-2);">
        üìé Qu·∫£n l√Ω v√† theo d√µi t·∫•t c·∫£ ph·ª• l·ª•c theo nƒÉm
      </p>
    </div>
    <form style="display: flex; gap: var(--space-2); align-items: center;" method="get" action="/annexes">
      <div class="form-group" style="margin: 0;">
        <input
          name="year"
          value="{{ year }}"
          class="form-input"
          placeholder="NƒÉm"
          style="width: 120px; border: 2px solid var(--teal-300);"
        />
      </div>
      <div class="form-group" style="margin: 0;">
        <select name="catalogue" class="form-input" style="width: 200px; border: 2px solid var(--primary-200);">
          <option value="all" {% if catalogue_filter == 'all' %}selected{% endif %}>T·∫•t c·∫£ danh m·ª•c</option>
          <option value="yes" {% if catalogue_filter in ['yes','has','1','true'] %}selected{% endif %}>C√≥ danh m·ª•c</option>
          <option value="no" {% if catalogue_filter in ['no','none','0','false'] %}selected{% endif %}>Ch∆∞a c√≥ danh m·ª•c</option>
        </select>
      </div>
      <button class="btn btn-info" type="submit">
        <svg style="width: 16px; height: 16px;" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
        </svg>
        L·ªçc
      </button>
    </form>
  </div>

  <div class="card-body">
    {% if error %}
      <div class="alert alert-error" style="margin-bottom: var(--space-4);">
        <div class="alert-content"><div class="alert-message">{{ error }}</div></div>
      </div>
    {% endif %}
    {% if message %}
      <div class="alert alert-success" style="margin-bottom: var(--space-4);">
        <div class="alert-content"><div class="alert-message">{{ message }}</div></div>
      </div>
    {% endif %}

    {% if has_permission(request, 'catalogue.upload') %}
    <div class="card" style="border-left: 4px solid var(--info-500); margin-bottom: var(--space-4);">
      <div class="card-body" style="padding: var(--space-4);">
        <div style="display:flex; gap: var(--space-3); flex-wrap: wrap; align-items: center; justify-content: space-between; margin-bottom: var(--space-3);">
          <div>
            <div style="font-weight: var(--font-semibold);">Upload danh m·ª•c Excel (g·∫Øn v√†o Ph·ª• l·ª•c)</div>
            <div style="font-size: var(--text-sm); color: var(--text-secondary);">T·∫£i m·∫´u, ƒëi·ªÅn d·ªØ li·ªáu, r·ªìi upload ƒë·ªÉ g·∫Øn file danh m·ª•c v√†o ph·ª• l·ª•c.</div>
          </div>
          <div style="display:flex; gap: var(--space-2); flex-wrap: wrap;">
            <a class="btn btn-secondary" href="/templates/import/contract/xlsx">T·∫£i m·∫´u Hƒê</a>
            <a class="btn btn-secondary" href="/templates/import/annex/xlsx">T·∫£i m·∫´u PL</a>
          </div>
        </div>

        <form method="post" action="/catalogue/upload" enctype="multipart/form-data" data-loading>
          <input type="hidden" name="year" value="{{ year }}" />
          <input type="hidden" name="next" value="/annexes?year={{ year }}" />
          <div style="display:flex; gap: var(--space-3); flex-wrap: wrap; align-items: flex-end;">
            <div class="form-group" style="margin: 0; min-width: 220px;">
              <label class="form-label">S·ªë h·ª£p ƒë·ªìng</label>
              <input class="form-input" type="text" name="contract_no" placeholder="VD: 01/2025/Hƒê..." required />
            </div>
            <div class="form-group" style="margin: 0; min-width: 180px;">
              <label class="form-label">S·ªë ph·ª• l·ª•c</label>
              <input class="form-input" type="text" name="annex_no" placeholder="VD: 01" required />
            </div>
            <div class="form-group" style="margin: 0; min-width: 320px;">
              <label class="form-label">File danh m·ª•c (.xlsx)</label>
              <input class="form-input" type="file" name="catalogue_file" accept=".xlsx" required data-no-dragdrop="1" />
            </div>
            <button class="btn btn-primary" type="submit">Upload</button>
            <a class="btn btn-info" href="/works/import">Import t√°c ph·∫©m</a>
          </div>
        </form>
      </div>
    </div>
    {% endif %}

    <div style="margin-bottom: var(--space-4); position: relative;">
      <svg style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); width: 20px; height: 20px; color: var(--teal-500); pointer-events: none;" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
      </svg>
      <input
        type="text"
        placeholder="üîç T√¨m ki·∫øm theo s·ªë Hƒê, s·ªë PL..."
        class="form-input"
        data-table-search="annexes-table"
        style="max-width: 500px; padding-left: var(--space-10); border: 2px solid var(--teal-200); background: linear-gradient(135deg, white 0%, var(--teal-50) 100%);"
      />
    </div>

    <div class="table-wrapper data-table-container" data-enhanced-table="annexes-table">
      <table class="table" data-sortable-table>
        <thead>
          <tr>
            <th data-sort="text">
              <div style="display: flex; align-items: center; gap: var(--space-2);">
                <svg style="width: 16px; height: 16px; color: var(--primary-600);" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14" />
                </svg>
                S·ªë h·ª£p ƒë·ªìng
              </div>
            </th>
            <th data-sort="text">
              <div style="display: flex; align-items: center; gap: var(--space-2);">
                <svg style="width: 16px; height: 16px; color: var(--teal-600);" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                S·ªë ph·ª• l·ª•c
              </div>
            </th>
            <th data-sort="text">
              <div style="display: flex; align-items: center; gap: var(--space-2);">
                <svg style="width: 16px; height: 16px; color: var(--purple-600);" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                </svg>
                ƒê∆°n v·ªã (Hƒê g·ªëc)
              </div>
            </th>
            <th data-sort="date">
              <div style="display: flex; align-items: center; gap: var(--space-2);">
                <svg style="width: 16px; height: 16px; color: var(--info-600);" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
                Ng√†y k√Ω PL
              </div>
            </th>
            <th data-sort="number">
              <div style="display: flex; align-items: center; gap: var(--space-2);">
                <svg style="width: 16px; height: 16px; color: var(--secondary-600);" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                Gi√° tr·ªã
              </div>
            </th>
            <th>Thao t√°c</th>
          </tr>
        </thead>
        <tbody data-table-body>
          {% for r in rows %}
            <tr class="annex-row"
                data-contract-no="{{ r.contract_no }}"
                data-year="{{ year }}"
                data-annex-no="{{ r.annex_no or 'Ch∆∞a c√≥' }}"
                data-channel="{{ r.kenh_ten or 'Ch∆∞a c√≥' }}"
                data-unit="{{ r.don_vi_ten or 'Ch∆∞a c√≥' }}"
                data-date-contract="{{ r.ngay_lap_hop_dong or 'Ch∆∞a c√≥' }}"
                data-date-annex="{{ r.ngay_ky_phu_luc or 'Ch∆∞a c√≥' }}"
                data-amount="{{ r.so_tien_nhuan_but_text or 'Ch∆∞a c√≥' }}"
                data-email="{{ r.don_vi_email or 'Ch∆∞a c√≥' }}"
                data-phone="{{ r.don_vi_dien_thoai or 'Ch∆∞a c√≥' }}">
              <td><strong style="color: var(--primary-700);" data-copy="{{ r.contract_no }}">{{ r.contract_no }}</strong></td>
              <td>
                {% if r.annex_no %}
                  <span class="badge badge-teal" data-copy="{{ r.annex_no }}">PL {{ r.annex_no }}</span>
                {% else %}
                  <span style="color: var(--text-tertiary);">-</span>
                {% endif %}
              </td>
              <td>
                {% if r.parent_contract %}
                  <div style="display: flex; flex-direction: column; gap: var(--space-1);">
                    <span style="font-weight: var(--font-medium);">{{ r.parent_contract.don_vi_ten[:30] }}{% if r.parent_contract.don_vi_ten|length > 30 %}...{% endif %}</span>
                    {% if r.parent_contract.kenh_ten %}
                      <span style="font-size: var(--text-xs); color: var(--text-tertiary);">üì∫ {{ r.parent_contract.kenh_ten[:20] }}</span>
                    {% endif %}
                  </div>
                {% else %}
                  <span style="color: var(--text-tertiary);">-</span>
                {% endif %}
              </td>
              <td><span style="color: var(--text-secondary); font-size: var(--text-sm);">{{ r.ngay_ky_phu_luc or r.ngay_lap_hop_dong or '-' }}</span></td>
              <td>
                {% if r.so_tien_nhuan_but_text %}
                  <span style="color: var(--secondary-700); font-weight: var(--font-semibold);" data-copy="{{ r.so_tien_nhuan_but_text }}">{{ r.so_tien_nhuan_but_text }}</span>
                  <span style="color: var(--text-tertiary); font-size: var(--text-xs);"> VNƒê</span>
                {% else %}
                  <span style="color: var(--text-tertiary);">-</span>
                {% endif %}
              </td>
              <td>
                <div class="actions-dropdown">
                  <button class="btn btn-sm btn-secondary dropdown-toggle" onclick="toggleDropdown(this, event)" title="Thao t√°c">
                    <svg style="width: 16px; height: 16px;" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" />
                    </svg>
                  </button>
                  <div class="dropdown-menu">
                    {% if r.download_url %}
                      <a class="dropdown-item" href="{{ r.download_url }}">
                        <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        T·∫£i file
                      </a>
                      <div class="dropdown-divider"></div>
                    {% endif %}
                    {% if r.catalogue_download_url %}
                      <a class="dropdown-item" href="{{ r.catalogue_download_url }}">
                        <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        T·∫£i danh m·ª•c
                      </a>
                    {% endif %}

                    {% if has_permission(request, 'catalogue.upload') %}
                    <a class="dropdown-item" href="/catalogue/upload?year={{ year }}&contract_no={{ r.contract_no|urlencode }}&annex_no={{ r.annex_no|urlencode }}">
                      <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                      </svg>
                      Upload danh m·ª•c
                    </a>

                    {% endif %}

                    {% if has_permission(request, 'annexes.delete') %}
                    <button class="dropdown-item dropdown-item-danger" onclick="deleteAnnex('{{ year }}', '{{ r.contract_no }}', '{{ r.annex_no }}')">
                      <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                      </svg>
                      X√≥a ph·ª• l·ª•c
                    </button>
                    {% endif %}
                  </div>
                </div>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>

      {% if rows|length == 0 %}
        <div class="empty-state">
          <svg class="empty-state-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
          <div class="empty-state-title">Ch∆∞a c√≥ ph·ª• l·ª•c</div>
          <div class="empty-state-description">Ch∆∞a c√≥ d·ªØ li·ªáu cho nƒÉm {{ year }}</div>
        </div>
      {% endif %}

      <div class="table-pagination" data-pagination-for="annexes-table"></div>
    </div>
  </div>

  <div class="card-footer" style="display: flex; gap: var(--space-3); justify-content: space-between; background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--teal-50) 100%);">
    {% if has_permission(request, 'annexes.create') %}
    <a href="/annexes/new" class="btn btn-primary">
      <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
      </svg>
      T·∫°o ph·ª• l·ª•c m·ªõi
    </a>
    {% endif %}
    {% if has_permission(request, 'works.read') %}
    <a href="/storage/excel/works/download/{{ year }}" class="btn btn-info">
      <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
      </svg>
      T·∫£i file danh m·ª•c t√°c ph·∫©m
    </a>
    {% endif %}
  </div>
</div>

<style>
.btn-danger {
  background: var(--error-600);
  color: white;
}

.btn-danger:hover {
  background: var(--error-700);
}

.annex-tooltip {
  position: absolute;
  background: white;
  border: 1px solid var(--neutral-200);
  border-radius: var(--radius-lg);
  padding: var(--space-4);
  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
  z-index: 9999;
  min-width: 350px;
  max-width: 450px;
  pointer-events: none;
  opacity: 0;
  transition: opacity 0.2s ease;
}

.annex-tooltip.show {
  opacity: 1;
}

.annex-tooltip h4 {
  margin: 0 0 var(--space-3) 0;
  font-size: var(--text-base);
  color: var(--teal-700);
  border-bottom: 2px solid var(--teal-200);
  padding-bottom: var(--space-2);
}

.annex-tooltip-row {
  display: flex;
  justify-content: space-between;
  padding: var(--space-2) 0;
  border-bottom: 1px solid var(--neutral-100);
  font-size: var(--text-sm);
}

.annex-tooltip-row:last-child {
  border-bottom: none;
}

.annex-tooltip-label {
  font-weight: var(--font-semibold);
  color: var(--text-secondary);
  flex: 0 0 40%;
}

.annex-tooltip-value {
  color: var(--text-primary);
  flex: 1;
  text-align: right;
  word-break: break-word;
}

.actions-dropdown {
  position: relative;
  display: inline-block;
}

.dropdown-toggle {
  cursor: pointer;
}

.dropdown-menu {
  display: none;
  position: absolute;
  right: 0;
  top: 100%;
  margin-top: var(--space-2);
  background: white;
  border: 1px solid var(--neutral-200);
  border-radius: var(--radius-md);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  min-width: 180px;
  z-index: 1000;
  overflow: hidden;
}

.dropdown-menu.show {
  display: block;
}

.dropdown-item {
  display: flex;
  align-items: center;
  gap: var(--space-2);
  width: 100%;
  padding: var(--space-2) var(--space-3);
  background: none;
  border: none;
  text-align: left;
  font-size: var(--text-sm);
  color: var(--text-primary);
  cursor: pointer;
  transition: background-color 0.2s;
  text-decoration: none;
}

.dropdown-item:hover {
  background: var(--neutral-50);
}

.dropdown-item .icon {
  width: 16px;
  height: 16px;
  flex-shrink: 0;
}

.dropdown-item-danger {
  color: var(--error-600);
}

.dropdown-item-danger:hover {
  background: var(--error-50);
}

.dropdown-divider {
  height: 1px;
  background: var(--neutral-200);
  margin: var(--space-1) 0;
}
</style>

<script>
function deleteAnnex(year, contractNo, annexNo) {
  if (!confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ph·ª• l·ª•c ${annexNo}?\n\nThao t√°c n√†y s·∫Ω x√≥a:\n- Ph·ª• l·ª•c kh·ªèi danh s√°ch\n- File Word ƒë√£ t·∫°o\n- File Excel danh m·ª•c\n\nH√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!`)) {
    return;
  }

  const url = `/annexes/${year}/delete?contract_no=${encodeURIComponent(contractNo)}&annex_no=${encodeURIComponent(annexNo)}`;
  fetch(url, { method: 'POST' })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        window.toast.success(data.message || 'ƒê√£ x√≥a ph·ª• l·ª•c');
        setTimeout(() => location.reload(), 1000);
      } else {
        window.toast.error(data.error || 'X√≥a th·∫•t b·∫°i');
      }
    })
    .catch(err => {
      window.toast.error('L·ªói: ' + err.message);
    });
}

// Dropdown Menu
function toggleDropdown(button, e) {
  if (e) {
    e.stopPropagation();
    e.preventDefault();
  }

  const dropdown = button.closest('.actions-dropdown');
  const menu = dropdown.querySelector('.dropdown-menu');
  const isCurrentlyOpen = menu.classList.contains('show');

  // Close all dropdowns first
  document.querySelectorAll('.dropdown-menu.show').forEach(m => {
    m.classList.remove('show');
  });

  // Toggle current dropdown (open if it was closed)
  if (!isCurrentlyOpen) {
    menu.classList.add('show');
  }
}

// Close dropdowns when clicking outside
document.addEventListener('click', function(e) {
  if (!e.target.closest('.actions-dropdown')) {
    document.querySelectorAll('.dropdown-menu.show').forEach(m => {
      m.classList.remove('show');
    });
  }
});

// Annex Row Tooltip - Using event delegation for dynamic content
(function() {
  const tooltip = document.createElement('div');
  tooltip.className = 'annex-tooltip';
  document.body.appendChild(tooltip);

  let showTimeout;
  let hideTimeout;
  let currentRow = null;

  // Use event delegation on document
  document.addEventListener('mouseenter', function(e) {
    const row = e.target.closest('.annex-row');
    if (!row) return;

    currentRow = row;
    clearTimeout(hideTimeout);

    const contractNo = row.dataset.contractNo;
    const annexNo = row.dataset.annexNo;
    const channel = row.dataset.channel;
    const unit = row.dataset.unit;
    const dateContract = row.dataset.dateContract;
    const dateAnnex = row.dataset.dateAnnex;
    const amount = row.dataset.amount;
    const email = row.dataset.email;
    const phone = row.dataset.phone;

    tooltip.innerHTML = `
      <h4>üìé ${contractNo} - Ph·ª• l·ª•c ${annexNo}</h4>
      <div class="annex-tooltip-row">
        <span class="annex-tooltip-label">K√™nh:</span>
        <span class="annex-tooltip-value">${channel}</span>
      </div>
      <div class="annex-tooltip-row">
        <span class="annex-tooltip-label">ƒê∆°n v·ªã:</span>
        <span class="annex-tooltip-value">${unit}</span>
      </div>
      <div class="annex-tooltip-row">
        <span class="annex-tooltip-label">Email:</span>
        <span class="annex-tooltip-value">${email}</span>
      </div>
      <div class="annex-tooltip-row">
        <span class="annex-tooltip-label">ƒêi·ªán tho·∫°i:</span>
        <span class="annex-tooltip-value">${phone}</span>
      </div>
      <div class="annex-tooltip-row">
        <span class="annex-tooltip-label">Ng√†y k√Ω Hƒê:</span>
        <span class="annex-tooltip-value">${dateContract}</span>
      </div>
      <div class="annex-tooltip-row">
        <span class="annex-tooltip-label">Ng√†y k√Ω PL:</span>
        <span class="annex-tooltip-value">${dateAnnex}</span>
      </div>
      <div class="annex-tooltip-row">
        <span class="annex-tooltip-label">Nhu·∫≠n b√∫t:</span>
        <span class="annex-tooltip-value" style="color: var(--secondary-600); font-weight: var(--font-semibold);">${amount} VNƒê</span>
      </div>
    `;

    showTimeout = setTimeout(() => {
      const rect = row.getBoundingClientRect();
      const tooltipRect = tooltip.getBoundingClientRect();

      let left = rect.right + 10;
      let top = rect.top + window.scrollY;

      // Check if tooltip goes off-screen to the right
      if (left + tooltipRect.width > window.innerWidth) {
        left = rect.left - tooltipRect.width - 10;
      }

      // Check if tooltip goes off-screen at bottom
      if (top + tooltipRect.height > window.innerHeight + window.scrollY) {
        top = window.innerHeight + window.scrollY - tooltipRect.height - 10;
      }

      tooltip.style.left = left + 'px';
      tooltip.style.top = top + 'px';
      tooltip.classList.add('show');
    }, 300);
  }, true);

  document.addEventListener('mouseleave', function(e) {
    const row = e.target.closest('.annex-row');
    if (!row || row !== currentRow) return;

    clearTimeout(showTimeout);
    hideTimeout = setTimeout(() => {
      tooltip.classList.remove('show');
    }, 100);
  }, true);
})();
</script>
{% endblock %}
