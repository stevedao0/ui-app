{% extends "base.html" %}
{% block content %}
<div class="card" style="margin-bottom: var(--space-8);">
  <div class="card-header" style="border-left: 4px solid var(--teal-500); background: linear-gradient(135deg, white 0%, var(--teal-50) 50%, var(--info-50) 100%);">
    <h1 class="card-title" style="color: var(--teal-800); display: flex; align-items: center; gap: var(--space-3);">
      <svg style="width: 32px; height: 32px; color: var(--teal-600);" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
      </svg>
      T·∫°o ph·ª• l·ª•c m·ªõi
    </h1>
    <p style="font-size: var(--text-sm); color: var(--text-secondary); margin: var(--space-2) 0 0 0;">
      üìé Ch·ªçn h·ª£p ƒë·ªìng ƒë√£ c√≥ ƒë·ªÉ t·ª± l·∫•y d·ªØ li·ªáu, nh·∫≠p s·ªë ph·ª• l·ª•c ƒë·ªÉ xu·∫•t Word
    </p>
  </div>

  <div class="card-body">
    {% if error %}
      <div class="alert alert-error">
        <svg class="alert-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
        <div class="alert-content">
          <div class="alert-message">{{ error }}</div>
        </div>
      </div>
    {% endif %}

    <form method="post" action="/annexes" data-validate-form data-loading>
      <div style="display: grid; gap: var(--space-6); grid-template-columns: 1fr;">
        <div class="form-group" style="position: relative;">
          <label class="form-label" for="contract_search">
            T√¨m h·ª£p ƒë·ªìng c√≥ s·∫µn (t√πy ch·ªçn)
          </label>
          <input
            id="contract_search"
            type="text"
            class="form-input"
            placeholder="G√µ s·ªë h·ª£p ƒë·ªìng ho·∫∑c t√™n k√™nh ƒë·ªÉ t√¨m ki·∫øm..."
            autocomplete="off"
            list="contract_suggestions"
            value="{{ selected_contract_no or '' }}"
          />
          <datalist id="contract_suggestions">
            {% for r in contracts[:50] %}
              <option value="{{ r.contract_no }}">{{ r.contract_no }}{% if r.kenh_ten %} - {{ r.kenh_ten }}{% endif %}</option>
            {% endfor %}
          </datalist>
          <div id="contract_search_results" style="position: absolute; z-index: 1000; background: white; border: 1px solid var(--gray-200); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-height: 300px; overflow-y: auto; display: none; width: 100%; margin-top: 2px;"></div>
          <div class="input-help-text">G√µ ƒë·ªÉ t√¨m ki·∫øm h·ª£p ƒë·ªìng, ch·ªçn ƒë·ªÉ t·ª± ƒë·ªông n·∫°p d·ªØ li·ªáu, ho·∫∑c b·ªè qua ƒë·ªÉ nh·∫≠p th·ªß c√¥ng</div>
        </div>
      </div>

      <div style="display: grid; gap: var(--space-6); grid-template-columns: 2fr 1fr 1fr; margin-top: var(--space-6);">
        <div class="form-group">
          <label class="form-label" for="contract_no">
            S·ªë h·ª£p ƒë·ªìng <span class="required-indicator">*</span>
          </label>
          <input
            id="contract_no"
            name="contract_no"
            type="text"
            value="{{ selected_contract_no or '' }}"
            placeholder="0001/2025/HƒêQTGAN-PN/MR"
            class="form-input"
            required
            data-validate
          />
          <div class="input-help-text">Nh·∫≠p ho·∫∑c ch·ªçn t·ª´ danh s√°ch tr√™n</div>
          <div class="input-error-text"></div>
        </div>

        <div class="form-group">
          <label class="form-label" for="annex_no">S·ªë ph·ª• l·ª•c</label>
          <input
            id="annex_no"
            name="annex_no"
            placeholder="001"
            class="form-input"
          />
          <div class="input-help-text">B·ªè tr·ªëng n·∫øu kh√¥ng c√≥</div>
        </div>

        <div class="form-group">
          <label class="form-label" for="ngay_ky_phu_luc">
            Ng√†y k√Ω ph·ª• l·ª•c <span class="required-indicator">*</span>
          </label>
          <input
            id="ngay_ky_phu_luc"
            name="ngay_ky_phu_luc"
            type="date"
            value="{{ preview.ngay_ky_phu_luc or today }}"
            class="form-input"
            required
            data-validate
          />
          <div class="input-error-text"></div>
        </div>
      </div>

      <div class="card" style="margin-top: var(--space-6); border-left: 4px solid var(--indigo-500);">
        <div class="card-header" style="background: linear-gradient(135deg, white 0%, var(--indigo-50) 100%);">
          <h3 style="font-size: var(--text-lg); margin: 0; color: var(--indigo-800); display: flex; align-items: center; gap: var(--space-2);">
            <svg style="width: 24px; height: 24px; color: var(--indigo-600);" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
            Ng√†y k√Ω h·ª£p ƒë·ªìng
          </h3>
        </div>
        <div class="card-body">
          <div class="form-group">
            <label class="form-label" for="ngay_ky_hop_dong">
              Ng√†y k√Ω h·ª£p ƒë·ªìng g·ªëc
            </label>
            <input
              id="ngay_ky_hop_dong"
              name="ngay_ky_hop_dong"
              type="date"
              value="{{ preview.ngay_lap_hop_dong or '' }}"
              class="form-input"
            />
            <div class="input-help-text">T·ª± ƒë·ªông l·∫•y t·ª´ h·ª£p ƒë·ªìng ƒë√£ ch·ªçn, ho·∫∑c nh·∫≠p th·ªß c√¥ng n·∫øu ch∆∞a c√≥</div>
            <div class="input-error-text"></div>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top: var(--space-6); border-left: 4px solid var(--purple-500);">
        <div class="card-header" style="background: linear-gradient(135deg, white 0%, var(--purple-50) 100%);">
          <h3 style="font-size: var(--text-lg); margin: 0; color: var(--purple-800); display: flex; align-items: center; gap: var(--space-2);">
            <svg style="width: 24px; height: 24px; color: var(--purple-600);" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
            </svg>
            Th√¥ng tin ƒë∆°n v·ªã (c√≥ th·ªÉ s·ª≠a)
          </h3>
        </div>
        <div class="card-body">
          <div style="display: grid; gap: var(--space-6); grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));">
            <div class="form-group" style="grid-column: 1 / -1;">
              <label class="form-label" for="don_vi_ten">T√™n ƒë∆°n v·ªã</label>
              <input
                id="don_vi_ten"
                name="don_vi_ten"
                value="{{ preview.don_vi_ten or '' }}"
                class="form-input"
              />
            </div>

            <div class="form-group" style="grid-column: 1 / -1;">
              <label class="form-label" for="don_vi_dia_chi">ƒê·ªãa ch·ªâ</label>
              <input
                id="don_vi_dia_chi"
                name="don_vi_dia_chi"
                value="{{ preview.don_vi_dia_chi or '' }}"
                class="form-input"
              />
            </div>

            <div class="form-group">
              <label class="form-label" for="don_vi_dien_thoai">ƒêi·ªán tho·∫°i</label>
              <input
                id="don_vi_dien_thoai"
                name="don_vi_dien_thoai"
                value="{{ preview.don_vi_dien_thoai or '' }}"
                class="form-input"
                placeholder="0901234567"
                data-validate
              />
              <div class="input-help-text">B·∫Øt ƒë·∫ßu b·∫±ng 0, c√≥ 10-11 s·ªë</div>
              <div class="input-error-text"></div>
            </div>

            <div class="form-group">
              <label class="form-label" for="don_vi_email">Email</label>
              <input
                id="don_vi_email"
                name="don_vi_email"
                type="email"
                value="{{ preview.don_vi_email or '' }}"
                class="form-input"
                placeholder="example@company.com"
                data-validate
              />
              <div class="input-error-text"></div>
            </div>

            <div class="form-group">
              <label class="form-label" for="nguoi_thuc_hien_email">Email ng∆∞·ªùi th·ª±c hi·ªán</label>
              <input
                id="nguoi_thuc_hien_email"
                name="nguoi_thuc_hien_email"
                type="email"
                value="{{ preview.nguoi_thuc_hien_email or '' }}"
                class="form-input"
                placeholder="executor@company.com"
              />
              <div class="input-help-text">Email ng∆∞·ªùi th·ª±c hi·ªán trong ph·ª• l·ª•c (kh√¥ng b·∫Øt bu·ªôc)</div>
              <div class="input-error-text"></div>
            </div>

            <div class="form-group">
              <label class="form-label" for="don_vi_nguoi_dai_dien">Ng∆∞·ªùi ƒë·∫°i di·ªán</label>
              <input
                id="don_vi_nguoi_dai_dien"
                name="don_vi_nguoi_dai_dien"
                value="{{ preview.don_vi_nguoi_dai_dien or '' }}"
                class="form-input"
              />
            </div>

            <div class="form-group">
              <label class="form-label" for="don_vi_chuc_vu">Ch·ª©c v·ª•</label>
              <input
                id="don_vi_chuc_vu"
                name="don_vi_chuc_vu"
                value="{{ preview.don_vi_chuc_vu or '' }}"
                class="form-input"
              />
            </div>

            <div class="form-group">
              <label class="form-label" for="so_CCCD">S·ªë CCCD/CMND</label>
              <input
                id="so_CCCD"
                name="so_CCCD"
                value="{{ preview.so_CCCD or '' }}"
                class="form-input"
                placeholder="001234567890"
              />
              <div class="input-help-text">S·ªë CƒÉn c∆∞·ªõc c√¥ng d√¢n ho·∫∑c Ch·ª©ng minh nh√¢n d√¢n</div>
              <div class="input-error-text"></div>
            </div>

            <div class="form-group">
              <label class="form-label" for="ngay_cap_CCCD">Ng√†y c·∫•p CCCD</label>
              <input
                id="ngay_cap_CCCD"
                name="ngay_cap_CCCD"
                value="{{ preview.ngay_cap_CCCD or '' }}"
                class="form-input"
                placeholder="01/01/2020"
              />
              <div class="input-help-text">Ng√†y c·∫•p cƒÉn c∆∞·ªõc (kh√¥ng b·∫Øt bu·ªôc)</div>
              <div class="input-error-text"></div>
            </div>

            <div class="form-group">
              <label class="form-label" for="don_vi_mst">M√£ s·ªë thu·∫ø</label>
              <input
                id="don_vi_mst"
                name="don_vi_mst"
                value="{{ preview.don_vi_mst or '' }}"
                class="form-input"
                placeholder="0123456789"
                data-validate
              />
              <div class="input-help-text">10-14 ch·ªØ s·ªë</div>
              <div class="input-error-text"></div>
            </div>

            <div class="form-group">
              <label class="form-label" for="linh_vuc">Lƒ©nh v·ª±c</label>
              <input
                id="linh_vuc"
                name="linh_vuc"
                value="{{ preview.linh_vuc or '' }}"
                class="form-input"
              />
            </div>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top: var(--space-6); border-left: 4px solid var(--pink-500);">
        <div class="card-header" style="background: linear-gradient(135deg, white 0%, var(--pink-50) 100%);">
          <h3 style="font-size: var(--text-lg); margin: 0; color: var(--pink-800); display: flex; align-items: center; gap: var(--space-2);">
            <svg style="width: 24px; height: 24px; color: var(--pink-600);" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
            </svg>
            Th√¥ng tin k√™nh
            <span style="font-size: var(--text-sm); color: var(--text-secondary); font-weight: 400; margin-left: var(--space-2);">(T√πy ch·ªçn)</span>
          </h3>
        </div>
        <div class="card-body">
          <div style="display: grid; gap: var(--space-6); grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));">
            <div class="form-group">
              <label class="form-label" for="kenh_ten">T√™n k√™nh</label>
              <input
                id="kenh_ten"
                name="kenh_ten"
                value="{{ preview.kenh_ten or '' }}"
                placeholder="V√≠ d·ª•: Thanh Ngoc Official"
                class="form-input"
              />
              <div class="input-help-text">ƒê·ªÉ tr·ªëng n·∫øu ch∆∞a c√≥ th√¥ng tin</div>
            </div>

            <div class="form-group">
              <label class="form-label" for="kenh_id">ID/Link k√™nh</label>
              <input
                id="kenh_id"
                name="kenh_id"
                value="{{ preview.kenh_id or '' }}"
                placeholder="UCxxxx ho·∫∑c https://youtube.com/channel/UCxxxx"
                class="form-input"
                data-validate
              />
              <div class="input-help-text">ƒê·ªÉ tr·ªëng n·∫øu ch∆∞a c√≥ th√¥ng tin</div>
              <div class="input-error-text"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top: var(--space-6); border-left: 4px solid var(--secondary-500);" data-money-calculator>
        <div class="card-header" style="background: linear-gradient(135deg, white 0%, var(--secondary-50) 100%);">
          <h3 style="font-size: var(--text-lg); margin: 0; color: var(--secondary-800); display: flex; align-items: center; gap: var(--space-2);">
            <svg style="width: 24px; height: 24px; color: var(--secondary-600);" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            Th√¥ng tin t√†i ch√≠nh
            <span style="font-size: var(--text-sm); color: var(--text-secondary); font-weight: 400; margin-left: var(--space-2);">(T√πy ch·ªçn)</span>
          </h3>
        </div>
        <div class="card-body">
          <div class="alert alert-info" style="margin-bottom: var(--space-6); padding: var(--space-4); background: rgba(59, 130, 246, 0.05); border-left: 3px solid var(--primary); border-radius: var(--radius-md);">
            <div style="display: flex; align-items: start; gap: var(--space-3);">
              <svg style="width: 20px; height: 20px; color: var(--primary); flex-shrink: 0; margin-top: 2px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              <div style="font-size: var(--text-sm); color: var(--text-secondary);">
                <strong style="color: var(--text-primary);">Ph·ª• l·ª•c cho h·ª£p ƒë·ªìng khung:</strong> N·∫øu h·ª£p ƒë·ªìng g·ªëc kh√¥ng c√≥ s·ªë ti·ªÅn (h·ª£p ƒë·ªìng khung), b·∫°n c√≥ th·ªÉ nh·∫≠p s·ªë ti·ªÅn c·ª• th·ªÉ cho ph·ª• l·ª•c n√†y.
              </div>
            </div>
          </div>

          <div style="display: grid; gap: var(--space-6); grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));">
            <div class="form-group">
              <label class="form-label" for="so_tien_chua_GTGT">S·ªë ti·ªÅn ch∆∞a VAT (VNƒê)</label>
              <div class="money-input-wrapper">
                <input
                  id="so_tien_chua_GTGT"
                  name="so_tien_chua_GTGT"
                  value="{{ preview.so_tien_chua_GTGT_text or '' }}"
                  placeholder="15,600,000 (ho·∫∑c ƒë·ªÉ tr·ªëng)"
                  class="form-input money-input"
                  data-money-input
                />
                <span class="money-currency">VNƒê</span>
              </div>
              <div class="input-help-text">Nh·∫≠p s·ªë ti·ªÅn c·ª• th·ªÉ cho ph·ª• l·ª•c n√†y</div>
            </div>

            <div class="form-group">
              <label class="form-label" for="thue_percent">Thu·∫ø GTGT (%)</label>
              <input
                id="thue_percent"
                name="thue_percent"
                type="number"
                value="10"
                min="0"
                max="100"
                class="form-input"
                data-vat-input
              />
              <div class="input-help-text">M·∫∑c ƒë·ªãnh 10%</div>
            </div>
          </div>

          <div class="money-calculator-preview">
            <div class="preview-row">
              <span>S·ªë ti·ªÅn ch∆∞a VAT:</span>
              <strong data-preview-pre-vat>{{ preview.so_tien_chua_GTGT_text or '0' }} VNƒê</strong>
            </div>
            <div class="preview-row">
              <span>Thu·∫ø GTGT (10%):</span>
              <strong data-preview-vat>{{ preview.thue_GTGT_text or '0' }} VNƒê</strong>
            </div>
            <div class="preview-row preview-total">
              <span>T·ªïng c·ªông:</span>
              <strong data-preview-total>{{ preview.so_tien_text or preview.so_tien_nhuan_but_text or '0' }} VNƒê</strong>
            </div>
            <div class="preview-row">
              <span style="font-size: var(--text-sm);">B·∫±ng ch·ªØ:</span>
              <em data-preview-words style="color: var(--text-tertiary);">{{ preview.so_tien_bang_chu or 'Kh√¥ng ƒë·ªìng' }}</em>
            </div>
          </div>
        </div>
      </div>

      <div style="margin-top: var(--space-8); display: flex; align-items: center; gap: var(--space-4); padding: var(--space-6); background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--teal-50) 100%); border-radius: var(--radius-lg);">
        <button type="submit" class="btn btn-primary btn-lg" data-submit-btn>
          <span class="btn-spinner">
            <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" stroke-opacity="0.25"/>
              <path fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"/>
            </svg>
          </span>
          <span class="btn-text">‚ú® Xu·∫•t Word ph·ª• l·ª•c + L∆∞u Excel</span>
        </button>
        <a href="/annexes" class="btn btn-info">
          <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
          Xem danh s√°ch
        </a>
      </div>
    </form>
  </div>
</div>

<div class="card" style="border-left: 4px solid var(--warning-500);">
  <div class="card-header" style="background: linear-gradient(135deg, white 0%, var(--warning-50) 100%);">
    <h3 class="card-title" style="font-size: var(--text-lg); color: var(--warning-800); display: flex; align-items: center; gap: var(--space-2);">
      <svg style="width: 20px; height: 20px; color: var(--warning-600);" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
      Ghi ch√∫ quan tr·ªçng
    </h3>
  </div>
  <div class="card-body" style="background: linear-gradient(135deg, white 0%, var(--warning-50) 100%);">
    <ul style="list-style: none; padding-left: 0; font-size: var(--text-sm); color: var(--text-secondary); line-height: var(--leading-relaxed); display: flex; flex-direction: column; gap: var(--space-2);">
      <li style="display: flex; align-items: start; gap: var(--space-2);">
        <span style="color: var(--teal-600); font-weight: bold;">‚Ä¢</span>
        <span>Ph·ª• l·ª•c s·∫Ω l·∫•y d·ªØ li·ªáu theo h·ª£p ƒë·ªìng ƒë√£ ch·ªçn ƒë·ªÉ h·∫°n ch·∫ø nh·∫≠p l·∫°i</span>
      </li>
      <li style="display: flex; align-items: start; gap: var(--space-2);">
        <span style="color: var(--primary-600); font-weight: bold;">‚Ä¢</span>
        <span>S·ªë ph·ª• l·ª•c n·∫øu ƒë·ªÉ tr·ªëng s·∫Ω b·ªè h·∫≥n trong t√™n file</span>
      </li>
      <li style="display: flex; align-items: start; gap: var(--space-2);">
        <span style="color: var(--warning-600); font-weight: bold;">‚Ä¢</span>
        <span>File Word ph·ª• l·ª•c s·∫Ω l∆∞u v√†o th∆∞ m·ª•c <code style="background: var(--warning-100); color: var(--warning-700); padding: 2px 6px; border-radius: var(--radius-sm);">storage/docx</code></span>
      </li>
      <li style="display: flex; align-items: start; gap: var(--space-2);">
        <span style="color: var(--info-600); font-weight: bold;">‚Ä¢</span>
        <span>T·∫•t c·∫£ th√¥ng tin s·∫Ω ƒë∆∞·ª£c validate tr∆∞·ªõc khi g·ª≠i</span>
      </li>
      <li style="display: flex; align-items: start; gap: var(--space-2);">
        <span style="color: var(--secondary-600); font-weight: bold;">‚Ä¢</span>
        <span>S·ªë ti·ªÅn s·∫Ω t·ª± ƒë·ªông ƒë∆∞·ª£c format v√† chuy·ªÉn th√†nh ch·ªØ ti·∫øng Vi·ªát</span>
      </li>
    </ul>
  </div>
</div>

<script>
  (function () {
    const contractSearch = document.getElementById('contract_search');
    const contractNoInput = document.getElementById('contract_no');
    const searchResults = document.getElementById('contract_search_results');

    if (!contractSearch || !contractNoInput) return;

    let allContracts = [];
    let searchTimeout = null;

    // Load all contracts on page load
    fetch('/api/contracts?year={{ year }}')
      .then(res => res.json())
      .then(data => {
        allContracts = data.contracts || [];
      })
      .catch(err => console.error('Failed to load contracts:', err));

    // Search functionality
    contractSearch.addEventListener('input', function () {
      clearTimeout(searchTimeout);
      const query = this.value.trim().toLowerCase();

      if (query.length < 2) {
        searchResults.style.display = 'none';
        return;
      }

      searchTimeout = setTimeout(() => {
        const filtered = allContracts.filter(c => {
          const contractNo = (c.contract_no || '').toLowerCase();
          const channelName = (c.kenh_ten || '').toLowerCase();
          return contractNo.includes(query) || channelName.includes(query);
        }).slice(0, 20);

        if (filtered.length > 0) {
          searchResults.innerHTML = filtered.map(c => `
            <div class="search-result-item" data-contract-no="${c.contract_no}" style="padding: var(--space-3); cursor: pointer; border-bottom: 1px solid var(--gray-100); hover:background: var(--gray-50);">
              <div style="font-weight: 600; color: var(--gray-900);">${c.contract_no}</div>
              <div style="font-size: var(--text-sm); color: var(--text-secondary);">${c.kenh_ten || 'Ch∆∞a c√≥ t√™n k√™nh'}</div>
            </div>
          `).join('');
          searchResults.style.display = 'block';

          // Add click handlers
          searchResults.querySelectorAll('.search-result-item').forEach(item => {
            item.addEventListener('click', function () {
              const contractNo = this.getAttribute('data-contract-no');
              contractSearch.value = contractNo;
              contractNoInput.value = contractNo;
              searchResults.style.display = 'none';

              // Reload page with selected contract
              const params = new URLSearchParams(window.location.search);
              params.set('year', '{{ year }}');
              params.set('contract_no', contractNo);
              window.location.href = '/annexes/new?' + params.toString();
            });

            item.addEventListener('mouseenter', function () {
              this.style.background = 'var(--gray-50)';
            });

            item.addEventListener('mouseleave', function () {
              this.style.background = 'white';
            });
          });
        } else {
          searchResults.innerHTML = '<div style="padding: var(--space-4); text-align: center; color: var(--text-secondary);">Kh√¥ng t√¨m th·∫•y h·ª£p ƒë·ªìng</div>';
          searchResults.style.display = 'block';
        }
      }, 300);
    });

    // Close results when clicking outside
    document.addEventListener('click', function (e) {
      if (!contractSearch.contains(e.target) && !searchResults.contains(e.target)) {
        searchResults.style.display = 'none';
      }
    });

    // Show results when focusing on input
    contractSearch.addEventListener('focus', function () {
      if (this.value.trim().length >= 2 && searchResults.children.length > 0) {
        searchResults.style.display = 'block';
      }
    });
  })();
</script>
{% endblock %}
